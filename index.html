<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Points</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4a90e2; --bg: #f8f9fa; --text: #2d3436; --card-bg: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        header { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .user-pill { background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        
        /* CONTENT */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); }
        h2 { color: var(--primary); margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* FORMS & LISTS */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: white; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-del { background: #ffebee; color: #ff4757; width: auto; padding: 8px 12px; margin: 0; }
        
        /* LOGIN SCREEN */
        #auth-screen { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; }
        
        /* NAVBAR */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #eee; display: grid; grid-template-columns: repeat(4, 1fr); height: 70px; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 11px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { font-size: 24px; margin-bottom: 3px; }

        /* MODAL (Ventana Emergente de Canjeo) */
        #redeem-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; }
        
        .hidden { display: none !important; }
        
        /* DIAGN√ìSTICO */
        #error-banner { display:none; background: #ff4757; color: white; padding: 10px; text-align: center; font-size: 0.8rem; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin:0 0 20px 0;">Family Points</h1>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button class="btn" onclick="app.login()">Entrar</button>
            <button class="btn" onclick="app.register()" style="background:white; color:var(--primary); border:1px solid var(--primary)">Crear Cuenta</button>
            <div id="error-banner"></div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <span id="header-name" class="user-pill">Cargando...</span>
            <button onclick="app.logout()" style="background:none; border:none; color:#666;">Salir</button>
        </header>

        <div class="main-content">
            
            <div id="view-ranking">
                <div class="card">
                    <h2>üèÜ Ranking</h2>
                    <div id="list-ranking">Cargando datos...</div>
                    <p id="loading-help" style="font-size:0.8rem; color:#999; display:none">
                        ‚ö†Ô∏è Si esto no carga en 5s, revisa los "Authorized Domains" en Firebase.
                    </p>
                </div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card">
                    <h2>‚ûï Sumar Puntos</h2>
                    <label>Actividad</label>
                    <select id="select-task"><option>Cargando...</option></select>
                    <label>Minutos</label>
                    <input type="number" id="input-time" placeholder="30">
                    <button class="btn" onclick="app.addPoints()">Guardar</button>
                </div>
            </div>

            <div id="view-redeem" class="hidden">
                <div class="card">
                    <h2>üéÅ Canjear</h2>
                    <p style="color:#666; font-size:0.9rem">Elige un premio para solicitarlo:</p>
                    <div id="list-redeem">Cargando premios...</div>
                </div>
            </div>

            <div id="view-settings" class="hidden">
                <div class="card">
                    <h2>‚öôÔ∏è Configuraci√≥n</h2>
                    <p>Usuario: <b id="my-email"></b></p>
                </div>

                <div class="card">
                    <h2>üë• Familia</h2>
                    <div id="list-users"></div>
                </div>

                <div class="card">
                    <h2>üßπ Actividades (Ganar)</h2>
                    <div id="list-tasks-admin"></div>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <input id="new-t-name" placeholder="Nombre">
                        <input id="new-t-pts" type="number" placeholder="Pts" style="width:70px">
                    </div>
                    <button class="btn" style="margin-top:5px; background:#2ecc71" onclick="app.createTask()">A√±adir</button>
                </div>

                <div class="card">
                    <h2>üéÅ Premios (Gastar)</h2>
                    <div id="list-rewards-admin"></div>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <input id="new-r-name" placeholder="Nombre">
                        <input id="new-r-cost" type="number" placeholder="Coste" style="width:70px">
                    </div>
                    <button class="btn" style="margin-top:5px; background:#2ecc71" onclick="app.createReward()">A√±adir</button>
                </div>
            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="app.nav('view-ranking', this)"><span>üèÜ</span>Ranking</div>
            <div class="nav-item" onclick="app.nav('view-add', this)"><span>‚ûï</span>Subir</div>
            <div class="nav-item" onclick="app.nav('view-redeem', this)"><span>üéÅ</span>Canjear</div>
            <div class="nav-item" onclick="app.nav('view-settings', this)"><span>‚öôÔ∏è</span>Ajustes</div>
        </nav>
    </div>

    <div id="redeem-modal" class="hidden">
        <div class="modal-content">
            <h2 style="border:none">üìÖ Elegir Fecha</h2>
            <p id="modal-title" style="font-weight:bold; color:#666"></p>
            
            <label style="text-align:left; display:block; margin-top:15px">Fecha para el canje:</label>
            <input type="date" id="modal-date" style="border:2px solid var(--primary)">
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" style="background:#ccc; color:#333" onclick="document.getElementById('redeem-modal').classList.add('hidden')">Cancelar</button>
                <button class="btn" onclick="app.confirmRedeem()">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // --- TUS CLAVES REALES ---
        const firebaseConfig = {
            apiKey: "AIzaSyDhaA-USi3WZD67ymUMTHdrSxvwuoHBgIE",
            authDomain: "familypoints-dic-25.firebaseapp.com",
            projectId: "familypoints-dic-25",
            storageBucket: "familypoints-dic-25.firebasestorage.app",
            messagingSenderId: "555839746134",
            appId: "1:555839746134:web:0bf1e28fbe47438e5a4bf7",
            measurementId: "G-VTXWQBVP02"
        };

        let db, auth, currentUser;
        let selectedReward = null; // Para guardar qu√© premio se est√° canjeando

        const app = {
            init: function() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.setup(user);
                        } else {
                            document.getElementById('auth-screen').classList.remove('hidden');
                        }
                    });

                    // Chivato de carga lenta
                    setTimeout(() => {
                        const rankText = document.getElementById('list-ranking').innerText;
                        if(rankText.includes("Cargando") && !document.getElementById('app-screen').classList.contains('hidden')) {
                            document.getElementById('loading-help').style.display = 'block';
                            alert("La app no conecta. ¬øHas a√±adido el dominio en Firebase Console -> Auth -> Settings?");
                        }
                    }, 4000);

                } catch(e) {
                    this.showError("Error inicial: " + e.message);
                }
            },

            setup: function(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                // Escuchar mi usuario
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        currentUser = { uid: user.uid, ...doc.data() };
                        document.getElementById('header-name').innerText = `${currentUser.name} (${currentUser.points})`;
                        document.getElementById('my-email').innerText = currentUser.email;
                    }
                });

                this.listenData();
            },

            listenData: function() {
                // 1. Usuarios (Ranking)
                db.collection('users').onSnapshot(snap => {
                    const list = document.getElementById('list-ranking');
                    const listUsers = document.getElementById('list-users');
                    list.innerHTML = ""; listUsers.innerHTML = "";
                    let users = [];
                    snap.forEach(d => users.push({id:d.id, ...d.data()}));
                    users.sort((a,b) => b.points - a.points);

                    users.forEach(u => {
                        list.innerHTML += `<div class="list-item"><b>${u.name}</b> <span class="user-pill">${u.points} pts</span></div>`;
                        
                        listUsers.innerHTML += `
                            <div class="list-item">
                                <span>${u.name} <small>(${u.email})</small></span>
                                <button class="btn-del" style="background:#eee; color:#333" onclick="app.editUser('${u.id}', '${u.name}')">‚úèÔ∏è</button>
                            </div>`;
                    });
                });

                // 2. Tareas
                db.collection('tasks').onSnapshot(snap => {
                    const sel = document.getElementById('select-task');
                    const list = document.getElementById('list-tasks-admin');
                    const oldVal = sel.value;
                    sel.innerHTML = "<option value=''>Elige actividad...</option>";
                    list.innerHTML = "";
                    
                    snap.forEach(d => {
                        const t = d.data();
                        // Select
                        let opt = document.createElement('option');
                        opt.value = d.id; opt.setAttribute('data-pts', t.pts); opt.text = `${t.name} (+${t.pts})`;
                        sel.appendChild(opt);
                        // Admin List
                        list.innerHTML += `<div class="list-item"><span>${t.name} (+${t.pts})</span> <button class="btn-del" onclick="app.del('tasks','${d.id}')">üóëÔ∏è</button></div>`;
                    });
                    sel.value = oldVal;
                });

                // 3. Premios (Rewards)
                db.collection('rewards').onSnapshot(snap => {
                    const listR = document.getElementById('list-redeem');
                    const listA = document.getElementById('list-rewards-admin');
                    listR.innerHTML = ""; listA.innerHTML = "";

                    snap.forEach(d => {
                        const r = d.data();
                        // Canjear List
                        const can = currentUser && currentUser.points >= r.cost;
                        const color = can ? 'var(--primary)' : '#ccc';
                        
                        listR.innerHTML += `
                            <div class="list-item">
                                <div><b>${r.name}</b><br><small>${r.cost} pts</small></div>
                                <button onclick="app.openRedeem('${d.id}', '${r.name}', ${r.cost})" 
                                    style="background:${color}; color:white; border:none; padding:8px 12px; border-radius:5px; font-weight:bold;">
                                    Canjear
                                </button>
                            </div>`;

                        // Admin List
                        listA.innerHTML += `<div class="list-item"><span>${r.name} (-${r.cost})</span> <button class="btn-del" onclick="app.del('rewards','${d.id}')">üóëÔ∏è</button></div>`;
                    });
                });
            },

            // --- ACCIONES ---

            openRedeem: function(id, name, cost) {
                if(currentUser.points < cost) return alert("No tienes suficientes puntos.");
                selectedReward = { id, name, cost };
                
                document.getElementById('modal-title').innerText = `Canjear: ${name} (${cost} pts)`;
                document.getElementById('modal-date').valueAsDate = new Date(); // Fecha de hoy
                document.getElementById('redeem-modal').classList.remove('hidden');
            },

            confirmRedeem: function() {
                const date = document.getElementById('modal-date').value;
                if(!date) return alert("Selecciona una fecha.");

                // 1. Restar Puntos
                db.collection('users').doc(currentUser.uid).update({
                    points: currentUser.points - selectedReward.cost
                });

                // 2. Preparar Email
                // Obtenemos todos los emails de la BD para ponerlos en copia
                db.collection('users').get().then(snap => {
                    let emails = [];
                    snap.forEach(d => emails.push(d.data().email));
                    const mailList = emails.join(',');
                    
                    const subject = encodeURIComponent("Solicitud Canje Puntos");
                    const body = encodeURIComponent(
                        `Hola,\n\n${currentUser.name} solicita canjear:\n` +
                        `üéÅ ${selectedReward.name}\n` +
                        `üìÖ Fecha: ${date}\n` +
                        `üí∞ Coste: ${selectedReward.cost} pts.\n`
                    );

                    window.location.href = `mailto:${mailList}?subject=${subject}&body=${body}`;
                    
                    alert("Canje registrado. Se abrir√° tu correo para notificar.");
                    document.getElementById('redeem-modal').classList.add('hidden');
                });
            },

            addPoints: function() {
                const sel = document.getElementById('select-task');
                const time = document.getElementById('input-time').value;
                if(!sel.value || !time) return alert("Rellena todo.");
                
                const pts = parseInt(sel.options[sel.selectedIndex].getAttribute('data-pts'));
                db.collection('users').doc(currentUser.uid).update({
                    points: (currentUser.points || 0) + pts
                });
                alert("Puntos sumados.");
                document.getElementById('input-time').value = "";
            },

            // --- ADMIN ---
            createTask: function() {
                const n = document.getElementById('new-t-name').value;
                const p = parseInt(document.getElementById('new-t-pts').value);
                if(n && p) {
                    db.collection('tasks').add({name:n, pts:p});
                    document.getElementById('new-t-name').value="";
                }
            },
            createReward: function() {
                const n = document.getElementById('new-r-name').value;
                const c = parseInt(document.getElementById('new-r-cost').value);
                if(n && c) {
                    db.collection('rewards').add({name:n, cost:c});
                    document.getElementById('new-r-name').value="";
                }
            },
            del: function(col, id) {
                if(confirm("¬øBorrar?")) db.collection(col).doc(id).delete();
            },
            editUser: function(id, name) {
                const n = prompt("Nuevo nombre:", name);
                if(n) db.collection('users').doc(id).update({name:n});
            },

            // --- AUTH ---
            login: async function() {
                try {
                    await auth.signInWithEmailAndPassword(
                        document.getElementById('email').value,
                        document.getElementById('pass').value
                    );
                } catch(e) { this.showError(e.message); }
            },
            register: async function() {
                try {
                    const e = document.getElementById('email').value;
                    const p = document.getElementById('pass').value;
                    const cred = await auth.createUserWithEmailAndPassword(e, p);
                    const name = e.split('@')[0];
                    await db.collection('users').doc(cred.user.uid).set({
                        name: name.charAt(0).toUpperCase() + name.slice(1), email: e, points: 0
                    });
                    alert("Creado con √©xito");
                } catch(e) { this.showError(e.message); }
            },
            logout: function() { auth.signOut(); location.reload(); },
            
            showError: function(msg) {
                const b = document.getElementById('error-banner');
                b.innerText = msg; b.style.display = 'block';
            },

            nav: function(view, el) {
                document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
                document.getElementById(view).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
