<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Points Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4a90e2; --accent: #50e3c2; --danger: #ff6b6b; --bg: #f8f9fa; --text: #2d3436; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* --- LOGIN --- */
        #auth-screen { position: fixed; inset: 0; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .login-card { background: white; padding: 30px; border-radius: 16px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .app-title { font-size: 2rem; color: white; font-weight: 800; margin-bottom: 20px; letter-spacing: -1px; }
        input { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #eee; border-radius: 10px; font-size: 16px; background: #fafafa; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; background: #fff; }
        .btn-auth { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-login { background: var(--primary); color: white; }
        .btn-register { background: white; border: 2px solid var(--primary); color: var(--primary); }

        /* --- APP UI --- */
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .user-badge { background: var(--primary); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; }
        
        h2 { margin: 0 0 15px 0; font-size: 1.2rem; color: var(--primary); font-weight: 700; }
        h3 { font-size: 0.85rem; text-transform: uppercase; color: #b2bec3; margin: 20px 0 10px 0; letter-spacing: 1px; font-weight: 700; }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
        .list-item:last-child { border-bottom: none; }
        
        /* Select & Inputs in App */
        select { width: 100%; height: 50px; border: 2px solid #eee; border-radius: 10px; padding: 0 10px; font-size: 16px; background: #fff; margin-bottom: 10px; }
        .row-inputs { display: flex; gap: 10px; }
        
        /* Botones */
        .btn { width: 100%; height: 50px; border: none; border-radius: 10px; font-weight: bold; color: white; font-size: 1rem; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3); }
        .btn-success { background: var(--accent); color: #006266; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; font-size: 1.1rem; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-left: 5px; }
        .btn-edit { background: #fff3cd; color: #856404; }
        .btn-del { background: #ffebee; color: var(--danger); }

        /* Calendario en Canjeo */
        .redeem-card { border: 2px solid transparent; transition: 0.3s; }
        .redeem-card.selected { border-color: var(--primary); background: #f0f7ff; }
        .date-picker-container { margin-top: 10px; display: none; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .date-picker-container.active { display: block; animation: fadeIn 0.3s; }
        input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }

        /* Navbar */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; border-top: 1px solid #f0f0f0; display: grid; grid-template-columns: repeat(4, 1fr); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: #b2bec3; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: bold; transform: translateY(-2px); }
        .nav-item span { font-size: 24px; margin-bottom: 4px; }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Spinner */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:bold; color:#666">Cargando Family Points...</div>
    </div>

    <div id="auth-screen">
        <div class="app-title">FAMILY POINTS</div>
        <div class="login-card">
            <h3 style="margin-top:0; margin-bottom:15px; text-align:center;">Acceso Familiar</h3>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            
            <button class="btn-auth btn-login" onclick="handleLogin()">Iniciar Sesi√≥n</button>
            <button class="btn-auth btn-register" onclick="handleRegister()">Crear Cuenta</button>
            <p id="login-msg" style="font-size: 0.8rem; color: var(--danger); margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <span id="user-display" class="user-badge">Cargando...</span>
            <button onclick="handleLogout()" style="background:none; border:none; color:#666; font-size:0.9rem; cursor:pointer">Salir</button>
        </header>

        <div class="main-content">
            
            <div id="view-ranking">
                <div class="card">
                    <h2>üèÜ Ranking Familiar</h2>
                    <div id="ranking-list">
                        <p style="text-align:center; color:#999">Cargando...</p>
                    </div>
                </div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card">
                    <h2>‚ûï Ganar Puntos</h2>
                    <p style="color:#666; font-size:0.9rem; margin-bottom:15px">Selecciona una tarea de la lista:</p>
                    <label>Actividad Realizada</label>
                    <select id="task-select">
                        <option value="">Cargando actividades...</option>
                    </select>
                    
                    <label>Tiempo (minutos)</label>
                    <input type="number" id="task-time" placeholder="Ej: 30">
                    
                    <button class="btn btn-primary" onclick="addPoints()">Registrar Tarea</button>
                </div>
            </div>

            <div id="view-redeem" class="hidden">
                <div class="card">
                    <h2>üéÅ Canjear Puntos</h2>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:15px">Elige un premio y selecciona una fecha.</p>
                    
                    <div id="redeem-list">
                        <p style="text-align:center; color:#999">Cargando premios...</p>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="hidden">
                
                <div class="card">
                    <h2>‚öôÔ∏è Mi Perfil</h2>
                    <p>Sesi√≥n iniciada como: <strong id="settings-email"></strong></p>
                </div>

                <div class="card">
                    <h2>üë• Familiares</h2>
                    <p style="font-size:0.8rem; color:#666">Edita los nombres si es necesario.</p>
                    <div id="users-list"></div>
                </div>

                <div class="card">
                    <h2>üßπ Actividades (Para ganar)</h2>
                    <div id="tasks-list"></div>
                    <h3>Nueva Actividad</h3>
                    <div class="row-inputs">
                        <input type="text" id="new-task-name" placeholder="Nombre (ej: Planchar)">
                        <input type="number" id="new-task-pts" placeholder="Pts" style="width:80px">
                    </div>
                    <button class="btn btn-success" onclick="createTask()">A√±adir Actividad</button>
                </div>

                <div class="card">
                    <h2>üéÅ Premios de Canjeo</h2>
                    <p style="font-size:0.8rem; color:#666">A√±ade aqu√≠ las opciones que saldr√°n en el men√∫ Canjear.</p>
                    <div id="rewards-list"></div>
                    <h3>Nuevo Premio</h3>
                    <div class="row-inputs">
                        <input type="text" id="new-reward-name" placeholder="Nombre (ej: Masaje)">
                        <input type="number" id="new-reward-cost" placeholder="Coste" style="width:80px">
                    </div>
                    <button class="btn btn-success" onclick="createReward()">A√±adir Premio</button>
                </div>

            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="nav('view-ranking', this)"><span>üèÜ</span>Ranking</div>
            <div class="nav-item" onclick="nav('view-add', this)"><span>‚ûï</span>Subir</div>
            <div class="nav-item" onclick="nav('view-redeem', this)"><span>üéÅ</span>Canjear</div>
            <div class="nav-item" onclick="nav('view-settings', this)"><span>‚öôÔ∏è</span>Ajustes</div>
        </nav>
    </div>

    <script>
        // -------------------------------------------------------------
        // CONFIGURACI√ìN (Tus claves)
        // -------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDhaA-USi3WZD67ymUMTHdrSxvwuoHBgIE",
            authDomain: "familypoints-dic-25.firebaseapp.com",
            projectId: "familypoints-dic-25",
            storageBucket: "familypoints-dic-25.firebasestorage.app",
            messagingSenderId: "555839746134",
            appId: "1:555839746134:web:0bf1e28fbe47438e5a4bf7",
            measurementId: "G-VTXWQBVP02"
        };
        // -------------------------------------------------------------

        let auth, db, currentUser = null;
        let allUsersEmails = []; // Para enviar el correo a todos

        // INICIALIZACI√ìN
        function initApp() {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();

            auth.onAuthStateChanged(user => {
                document.getElementById('loading-overlay').classList.add('hidden');
                if (user) {
                    setupApp(user);
                } else {
                    showAuth();
                }
            });
        }

        function showAuth() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }

        function setupApp(user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    currentUser = { uid: user.uid, ...doc.data() };
                    document.getElementById('user-display').innerText = `${currentUser.name} (${currentUser.points})`;
                    document.getElementById('settings-email').innerText = currentUser.email;
                }
            });

            listenToData();
        }

        function nav(viewId, el) {
            document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        // --- AUTH ---
        async function handleLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await auth.signInWithEmailAndPassword(e, p); } 
            catch (err) { alert(err.message); }
        }

        async function handleRegister() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try {
                const cred = await auth.createUserWithEmailAndPassword(e, p);
                const name = e.split('@')[0];
                await db.collection('users').doc(cred.user.uid).set({
                    name: name.charAt(0).toUpperCase() + name.slice(1),
                    email: e,
                    points: 0
                });
                alert("Usuario creado. ¬°Bienvenido!");
            } catch (err) { alert(err.message); }
        }

        function handleLogout() { auth.signOut(); location.reload(); }

        // --- LISTENERS DE DATOS ---
        function listenToData() {
            // 1. Usuarios
            db.collection('users').onSnapshot(snap => {
                const list = document.getElementById('ranking-list');
                const listSet = document.getElementById('users-list');
                list.innerHTML = ""; listSet.innerHTML = "";
                allUsersEmails = [];

                let users = [];
                snap.forEach(doc => {
                    const u = doc.data();
                    users.push({id: doc.id, ...u});
                    allUsersEmails.push(u.email);
                });
                
                users.sort((a,b) => b.points - a.points);

                users.forEach(u => {
                    // Ranking
                    list.innerHTML += `
                        <div class="list-item">
                            <span style="font-weight:600">${u.name}</span>
                            <span class="user-badge" style="background:#e3f2fd; color:var(--primary)">${u.points} pts</span>
                        </div>`;
                    
                    // Ajustes (Edici√≥n)
                    listSet.innerHTML += `
                        <div class="list-item">
                            <div style="flex:1">
                                <strong>${u.name}</strong><br>
                                <small>${u.email}</small>
                            </div>
                            <button class="btn-icon btn-edit" onclick="editUser('${u.id}', '${u.name}')">‚úèÔ∏è</button>
                        </div>`;
                });
            });

            // 2. Actividades (Tasks)
            db.collection('tasks').onSnapshot(snap => {
                const select = document.getElementById('task-select');
                const list = document.getElementById('tasks-list');
                const currentVal = select.value;
                select.innerHTML = "<option value=''>Selecciona...</option>";
                list.innerHTML = "";

                snap.forEach(doc => {
                    const t = doc.data();
                    // Select Subir
                    const opt = document.createElement('option');
                    opt.value = doc.id; opt.setAttribute('data-pts', t.pts);
                    opt.text = `${t.name} (+${t.pts})`;
                    select.appendChild(opt);

                    // Lista Ajustes
                    list.innerHTML += `
                        <div class="list-item">
                            <span>${t.name} (+${t.pts})</span>
                            <button class="btn-icon btn-del" onclick="deleteDoc('tasks', '${doc.id}')">üóëÔ∏è</button>
                        </div>`;
                });
                select.value = currentVal;
            });

            // 3. Premios (Rewards)
            db.collection('rewards').onSnapshot(snap => {
                const redeemList = document.getElementById('redeem-list');
                const setList = document.getElementById('rewards-list');
                redeemList.innerHTML = ""; setList.innerHTML = "";

                snap.forEach(doc => {
                    const r = doc.data();
                    
                    // Ajustes (Edici√≥n)
                    setList.innerHTML += `
                        <div class="list-item">
                            <span>${r.name} (-${r.cost})</span>
                            <button class="btn-icon btn-del" onclick="deleteDoc('rewards', '${doc.id}')">üóëÔ∏è</button>
                        </div>`;

                    // Canjear (Con Calendario)
                    const canAfford = currentUser && currentUser.points >= r.cost;
                    const opacity = canAfford ? '1' : '0.6';
                    
                    redeemList.innerHTML += `
                        <div class="card redeem-card" id="card-${doc.id}" style="opacity:${opacity}; margin-bottom:10px; padding:15px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong style="font-size:1.1rem; color:var(--primary)">${r.name}</strong>
                                    <div style="font-weight:bold; color:#666">${r.cost} pts</div>
                                </div>
                                <button class="btn-icon" style="background:${canAfford?'var(--primary)':'#ccc'}; color:white; width:40px; height:40px;" 
                                    onclick="toggleDate('${doc.id}', ${r.cost}, '${r.name}')">üìÖ</button>
                            </div>
                            
                            <div id="date-box-${doc.id}" class="date-picker-container">
                                <label style="display:block; margin-bottom:5px; font-size:0.85rem">Fecha deseada:</label>
                                <input type="date" id="date-${doc.id}">
                                <button class="btn btn-primary" style="height:40px; margin-top:10px; font-size:0.9rem"
                                    onclick="processRedeem('${r.name}', ${r.cost}, 'date-${doc.id}')">
                                    Confirmar y Enviar Mail ‚úâÔ∏è
                                </button>
                            </div>
                        </div>`;
                });
            });
        }

        // --- FUNCIONES L√ìGICAS ---

        // 1. Modificar Usuario
        function editUser(uid, oldName) {
            const newName = prompt("Nuevo nombre para este usuario:", oldName);
            if(newName && newName !== oldName) {
                db.collection('users').doc(uid).update({ name: newName })
                .then(() => alert("Nombre actualizado"));
            }
        }

        // 2. Subir Puntos
        function addPoints() {
            const sel = document.getElementById('task-select');
            const time = document.getElementById('task-time').value;
            if(!sel.value || !time) return alert("Rellena todos los campos");

            const pts = parseInt(sel.options[sel.selectedIndex].getAttribute('data-pts'));
            const newTotal = (currentUser.points || 0) + pts;

            db.collection('users').doc(currentUser.uid).update({ points: newTotal })
            .then(() => {
                alert(`¬°+${pts} puntos guardados!`);
                nav('view-ranking', document.querySelector('.nav-item'));
            });
        }

        // 3. Canjear (L√≥gica UI)
        function toggleDate(id, cost, name) {
            if(currentUser.points < cost) return alert("No tienes suficientes puntos.");
            
            // Cerrar otros
            document.querySelectorAll('.date-picker-container').forEach(el => el.classList.remove('active'));
            // Abrir este
            document.getElementById(`date-box-${id}`).classList.add('active');
        }

        // 4. Procesar Canje y Enviar Mail
        function processRedeem(rewardName, cost, dateInputId) {
            const dateVal = document.getElementById(dateInputId).value;
            if(!dateVal) return alert("Por favor, selecciona una fecha en el calendario.");

            if(confirm(`¬øCanjear "${rewardName}" para el d√≠a ${dateVal}? Se descontar√°n ${cost} puntos.`)) {
                
                // A. Restar Puntos
                const newTotal = currentUser.points - cost;
                db.collection('users').doc(currentUser.uid).update({ points: newTotal });

                // B. Guardar en Historial (Opcional, pero recomendado)
                // db.collection('history').add({ ... }) 

                // C. Enviar Email (Simulado v√≠a Mailto)
                const subject = encodeURIComponent("üì¢ Solicitud de Canje - Family Points");
                const body = encodeURIComponent(
                    `Hola familia,\n\n` +
                    `${currentUser.name} quiere canjear sus puntos.\n\n` +
                    `üéÅ Actividad: ${rewardName}\n` +
                    `üìÖ Fecha deseada: ${dateVal}\n` +
                    `üí∞ Coste: ${cost} puntos\n\n` +
                    `Por favor, confirmar si os va bien.`
                );

                // Abrir cliente de correo con destinatarios (todos menos yo, o todos)
                const recipients = allUsersEmails.join(',');
                window.location.href = `mailto:${recipients}?subject=${subject}&body=${body}`;

                alert("Puntos descontados. Enviando solicitud por correo...");
                nav('view-ranking', document.querySelector('.nav-item'));
            }
        }

        // --- GESTI√ìN DE CONTENIDO (AJUSTES) ---
        function createTask() {
            const n = document.getElementById('new-task-name').value;
            const p = parseInt(document.getElementById('new-task-pts').value);
            if(n && p) {
                db.collection('tasks').add({name: n, pts: p});
                document.getElementById('new-task-name').value = "";
                document.getElementById('new-task-pts').value = "";
            }
        }

        function createReward() {
            const n = document.getElementById('new-reward-name').value;
            const c = parseInt(document.getElementById('new-reward-cost').value);
            if(n && c) {
                db.collection('rewards').add({name: n, cost: c});
                document.getElementById('new-reward-name').value = "";
                document.getElementById('new-reward-cost').value = "";
            }
        }

        function deleteDoc(col, id) {
            if(confirm("¬øBorrar este elemento para todos?")) db.collection(col).doc(id).delete();
        }

        window.onload = initApp;
    </script>
</body>
</html>
