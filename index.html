<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Points Final</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4a90e2; --bg: #f0f2f5; --text: #333; --card: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        header { background: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-pill { background: var(--primary); color: white; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        
        /* CONTENIDO */
        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 8px; }

        /* ELEMENTOS */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        input, select { width: 100%; padding: 12px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-size: 16px; }
        
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; margin-top: 5px; }
        .btn-del { background: #ff7675; width: auto; padding: 5px 10px; margin: 0; font-size: 0.8rem; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        /* LOGIN */
        #auth-screen { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 320px; text-align: center; }

        /* NAVBAR */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: grid; grid-template-columns: repeat(4, 1fr); height: 65px; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; font-size: 10px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { font-size: 22px; margin-bottom: 2px; }

        /* MODAL */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 320px; text-align: center; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin:0 0 15px;">Family Points</h1>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button class="btn" onclick="app.login()">Entrar</button>
            <button class="btn" onclick="app.register()" style="background:white; color:var(--primary); border:1px solid var(--primary)">Registrarse</button>
            <p id="auth-error" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <span id="header-user" class="user-pill">Cargando...</span>
            <button onclick="app.logout()" style="border:none; background:none; color:#666;">Salir</button>
        </header>

        <div class="main-content">
            
            <div id="view-ranking">
                <div class="card">
                    <h2>üèÜ Ranking</h2>
                    <div id="list-ranking">Cargando...</div>
                </div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card">
                    <h2>‚ûï Ganar Puntos</h2>
                    <label>Actividad</label>
                    <select id="select-task"><option>Cargando...</option></select>
                    <label>Minutos</label>
                    <input type="number" id="input-time" placeholder="Ej: 30">
                    <button class="btn" onclick="app.addPoints()">Guardar</button>
                </div>
            </div>

            <div id="view-redeem" class="hidden">
                <div class="card">
                    <h2>üéÅ Canjear</h2>
                    <p style="color:#666; font-size:0.9rem">Elige un premio:</p>
                    <div id="list-redeem"></div>
                </div>
            </div>

            <div id="view-settings" class="hidden">
                <div class="card">
                    <h2>‚öôÔ∏è Mi Perfil</h2>
                    <p>Soy: <b id="my-email"></b></p>
                </div>

                <div class="card">
                    <h2>üë• Usuarios (Admin)</h2>
                    <div id="list-users"></div>
                </div>

                <div class="card">
                    <h2>üßπ Actividades</h2>
                    <div id="list-tasks-admin"></div>
                    <div style="display:flex; gap:5px; margin-top:10px">
                        <input id="new-t-name" placeholder="Nombre">
                        <input id="new-t-pts" type="number" placeholder="Pts" style="width:70px">
                    </div>
                    <button class="btn" onclick="app.createTask()">Crear Actividad</button>
                </div>

                <div class="card">
                    <h2>üéÅ Premios</h2>
                    <div id="list-rewards-admin"></div>
                    <div style="display:flex; gap:5px; margin-top:10px">
                        <input id="new-r-name" placeholder="Nombre">
                        <input id="new-r-cost" type="number" placeholder="Pts" style="width:70px">
                    </div>
                    <button class="btn" onclick="app.createReward()">Crear Premio</button>
                </div>
            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="app.nav('view-ranking', this)"><span>üèÜ</span>Ranking</div>
            <div class="nav-item" onclick="app.nav('view-add', this)"><span>‚ûï</span>Subir</div>
            <div class="nav-item" onclick="app.nav('view-redeem', this)"><span>üéÅ</span>Canjear</div>
            <div class="nav-item" onclick="app.nav('view-settings', this)"><span>‚öôÔ∏è</span>Ajustes</div>
        </nav>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-box">
            <h3 id="modal-title">Elegir Fecha</h3>
            <input type="date" id="modal-date" style="border:2px solid var(--primary); padding:15px;">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" style="background:#ccc; color:#333" onclick="document.getElementById('modal-overlay').classList.add('hidden')">Cancelar</button>
                <button class="btn" onclick="app.confirmRedeem()">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // --- PEGA AQU√ç TU CONFIGURACI√ìN SI CAMBIA ---
        const firebaseConfig = {
            apiKey: "AIzaSyDhaA-USi3WZD67ymUMTHdrSxvwuoHBgIE",
            authDomain: "familypoints-dic-25.firebaseapp.com",
            projectId: "familypoints-dic-25",
            storageBucket: "familypoints-dic-25.firebasestorage.app",
            messagingSenderId: "555839746134",
            appId: "1:555839746134:web:0bf1e28fbe47438e5a4bf7",
            measurementId: "G-VTXWQBVP02"
        };

        let db, auth, currentUser;
        let selectedReward = null;

        const app = {
            init: function() {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.setup(user);
                    } else {
                        document.getElementById('auth-screen').classList.remove('hidden');
                        document.getElementById('app-screen').classList.add('hidden');
                    }
                });
            },

            setup: function(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');

                // Listener de MI usuario (con Auto-Reparaci√≥n)
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        currentUser = { uid: user.uid, ...doc.data() };
                        
                        // PARCHE: Si el usuario existe pero no tiene nombre (es undefined), lo arreglamos
                        if(!currentUser.name || currentUser.name === 'undefined') {
                            db.collection('users').doc(user.uid).update({
                                name: user.email.split('@')[0],
                                points: 0
                            });
                        }

                        document.getElementById('header-user').innerText = `${currentUser.name} (${currentUser.points})`;
                        document.getElementById('my-email').innerText = currentUser.email;
                    } else {
                        // Si no existe el documento, lo creamos
                        db.collection('users').doc(user.uid).set({
                            name: user.email.split('@')[0],
                            email: user.email,
                            points: 0
                        });
                    }
                });

                this.listenData();
            },

            listenData: function() {
                // Usuarios
                db.collection('users').onSnapshot(snap => {
                    const list = document.getElementById('list-ranking');
                    const listSet = document.getElementById('list-users');
                    list.innerHTML = ""; listSet.innerHTML = "";
                    let users = [];
                    snap.forEach(d => users.push({id:d.id, ...d.data()}));
                    users.sort((a,b) => (b.points||0) - (a.points||0));

                    users.forEach(u => {
                        const safeName = u.name || "Sin nombre";
                        const safeEmail = u.email || "Sin email";
                        
                        list.innerHTML += `<div class="list-item"><b>${safeName}</b> <span class="user-pill">${u.points || 0}</span></div>`;
                        
                        listSet.innerHTML += `
                            <div class="list-item">
                                <span style="font-size:0.8rem">${safeName}<br><small>${safeEmail}</small></span>
                                <div>
                                    <button class="btn-icon" onclick="app.editUser('${u.id}', '${safeName}')">‚úèÔ∏è</button>
                                    <button class="btn-icon" style="color:red" onclick="app.del('users', '${u.id}')">üóëÔ∏è</button>
                                </div>
                            </div>`;
                    });
                });

                // Tareas
                db.collection('tasks').onSnapshot(snap => {
                    const sel = document.getElementById('select-task');
                    const list = document.getElementById('list-tasks-admin');
                    const oldVal = sel.value;
                    sel.innerHTML = "<option value=''>Elige...</option>";
                    list.innerHTML = "";
                    snap.forEach(d => {
                        const t = d.data();
                        let opt = document.createElement('option');
                        opt.value = d.id; opt.setAttribute('data-pts', t.pts); opt.text = `${t.name} (+${t.pts})`;
                        sel.appendChild(opt);
                        list.innerHTML += `<div class="list-item"><span>${t.name} (+${t.pts})</span> <button class="btn-del" onclick="app.del('tasks','${d.id}')">Borrar</button></div>`;
                    });
                    sel.value = oldVal;
                });

                // Premios
                db.collection('rewards').onSnapshot(snap => {
                    const listR = document.getElementById('list-redeem');
                    const listA = document.getElementById('list-rewards-admin');
                    listR.innerHTML = ""; listA.innerHTML = "";
                    snap.forEach(d => {
                        const r = d.data();
                        const can = currentUser && (currentUser.points || 0) >= r.cost;
                        const color = can ? 'var(--primary)' : '#ccc';
                        
                        listR.innerHTML += `
                            <div class="list-item">
                                <div><b>${r.name}</b><br><small>${r.cost} pts</small></div>
                                <button onclick="app.askRedeem('${r.name}', ${r.cost})" 
                                    style="background:${color}; color:white; border:none; padding:8px 12px; border-radius:5px;">Canjear</button>
                            </div>`;
                            
                        listA.innerHTML += `<div class="list-item"><span>${r.name} (-${r.cost})</span> <button class="btn-del" onclick="app.del('rewards','${d.id}')">Borrar</button></div>`;
                    });
                });
            },

            // LOGICA
            addPoints: function() {
                const sel = document.getElementById('select-task');
                const time = document.getElementById('input-time').value;
                if(!sel.value || !time) return alert("Rellena todo");
                const pts = parseInt(sel.options[sel.selectedIndex].getAttribute('data-pts'));
                
                db.collection('users').doc(currentUser.uid).update({
                    points: (currentUser.points || 0) + pts
                });
                alert("¬°Puntos guardados!");
                app.nav('view-ranking', document.querySelector('.nav-item'));
            },

            askRedeem: function(name, cost) {
                if((currentUser.points || 0) < cost) return alert("Te faltan puntos.");
                selectedReward = { name, cost };
                document.getElementById('modal-title').innerText = "Canjear: " + name;
                document.getElementById('modal-date').valueAsDate = new Date();
                document.getElementById('modal-overlay').classList.remove('hidden');
            },

            confirmRedeem: function() {
                const date = document.getElementById('modal-date').value;
                if(!date) return alert("Pon una fecha");

                // Restar puntos
                db.collection('users').doc(currentUser.uid).update({
                    points: currentUser.points - selectedReward.cost
                });

                // Enviar Mail
                db.collection('users').get().then(snap => {
                    let emails = [];
                    snap.forEach(d => { 
                        const u = d.data();
                        if(u.email) emails.push(u.email);
                    });
                    
                    const subject = encodeURIComponent("Canje Family Points");
                    const body = encodeURIComponent(
                        `Hola,\n\n${currentUser.name} solicita canjear:\nPremio: ${selectedReward.name}\nFecha: ${date}\nCoste: ${selectedReward.cost} pts.`
                    );
                    
                    window.location.href = `mailto:${emails.join(',')}?subject=${subject}&body=${body}`;
                    
                    document.getElementById('modal-overlay').classList.add('hidden');
                    alert("Canje registrado. Enviando mail...");
                });
            },

            createTask: function() {
                const n = document.getElementById('new-t-name').value;
                const p = parseInt(document.getElementById('new-t-pts').value);
                if(n && p) { db.collection('tasks').add({name:n, pts:p}); document.getElementById('new-t-name').value=""; }
            },
            createReward: function() {
                const n = document.getElementById('new-r-name').value;
                const c = parseInt(document.getElementById('new-r-cost').value);
                if(n && c) { db.collection('rewards').add({name:n, cost:c}); document.getElementById('new-r-name').value=""; }
            },
            
            del: function(col, id) { if(confirm("¬øBorrar?")) db.collection(col).doc(id).delete(); },
            
            editUser: function(id, currentName) {
                const n = prompt("Nuevo nombre:", currentName);
                if(n) db.collection('users').doc(id).update({name: n});
            },

            // AUTH
            login: function() {
                const e = document.getElementById('email').value;
                const p = document.getElementById('pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(err => document.getElementById('auth-error').innerText = err.message);
            },
            register: function() {
                const e = document.getElementById('email').value;
                const p = document.getElementById('pass').value;
                auth.createUserWithEmailAndPassword(e, p).then(cred => {
                    const name = e.split('@')[0];
                    return db.collection('users').doc(cred.user.uid).set({name: name, email: e, points: 0});
                }).catch(err => document.getElementById('auth-error').innerText = err.message);
            },
            logout: function() { auth.signOut(); location.reload(); },

            nav: function(view, el) {
                document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
                document.getElementById(view).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
