<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Points Admin</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4a90e2; --bg: #f0f2f5; --text: #333; --card: #fff; --admin: #2d3436; --observer: #6c5ce7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        header { background: #fff; padding: 10px 15px; display: flex; flex-direction: column; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .family-badge { background: #e17055; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-top: 5px; align-self: flex-start; }
        .observer-badge { background: var(--observer); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-top: 5px; align-self: flex-start; display:none; }
        
        .user-pill { background: var(--primary); color: white; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        
        /* PANEL ADMIN */
        #admin-panel { background: var(--admin); color: white; padding: 15px; display: none; }
        #admin-panel h3 { margin: 0 0 10px 0; color: #fab1a0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .admin-card { background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 0.9rem; display: flex; flex-direction:column; gap:8px; }
        .admin-actions { display: flex; gap: 5px; flex-wrap: wrap; }

        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 8px; }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        
        input, select { width: 100%; padding: 12px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-size: 16px; }
        
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; margin-top: 5px; cursor: pointer; }
        .btn-sec { background: #636e72; margin-top: 10px; }
        
        /* Botones Admin Peque√±os */
        .btn-mini { font-size: 0.75rem; padding: 5px 10px; width: auto; border:none; border-radius:4px; color:white; cursor:pointer; }
        .btn-copy { background: #00b894; }
        .btn-move { background: #0984e3; }
        .btn-del { background: #d63031; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        .input-group { display: flex; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .input-group input { margin-bottom: 0; }

        #auth-screen, #join-screen { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 320px; text-align: center; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: grid; grid-template-columns: repeat(4, 1fr); height: 65px; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { font-size: 22px; margin-bottom: 2px; }

        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 320px; text-align: center; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin:0 0 15px;">Family Points</h1>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button class="btn" onclick="app.login()">Entrar</button>
            <button class="btn" onclick="app.register()" style="background:white; color:var(--primary); border:1px solid var(--primary)">Registrarse</button>
            <p id="auth-error" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="join-screen" class="hidden">
        <div class="login-box">
            <h2 style="color:var(--primary);">¬°Hola! üëã</h2>
            <p>A√∫n no perteneces a ninguna familia.</p>
            <p style="font-size:0.9rem; color:#666;">Pide al administrador que te env√≠e el <b>Link de Invitaci√≥n</b>.</p>
            <div style="border-top:1px solid #eee; margin:15px 0; padding-top:10px;">
                <p style="font-size:0.8rem;">O si eres el <b>Super Admin</b>, crea una familia abajo:</p>
                <button class="btn btn-sec" onclick="app.logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        
        <div id="admin-panel">
            <h3>üï¥Ô∏è Super Admin Zone</h3>
            <p style="font-size:0.8rem; margin-bottom:10px;">Busca tu familia original y pulsa "Mudarme Aqu√≠" para arreglar tu usuario.</p>
            <div class="input-group" style="border:none; padding:0; margin-bottom:10px;">
                <input id="sa-fam-name" placeholder="Nombre nueva familia" style="background:rgba(255,255,255,0.9);">
                <button class="btn" style="width:auto; margin-top:5px;" onclick="app.saCreateFamily()">Crear</button>
            </div>
            <div id="sa-fam-list"></div>
        </div>

        <header>
            <div class="header-top">
                <span id="header-user" class="user-pill">Cargando...</span>
                <button onclick="app.logout()" style="border:none; background:none; color:#666; font-size:0.9rem;">Salir</button>
            </div>
            <div id="header-family-name" class="family-badge">Cargando familia...</div>
            <div id="observer-mode" class="observer-badge">üëÅÔ∏è MODO OBSERVADOR (Admin)</div>
        </header>

        <div class="main-content">
            <div id="view-ranking">
                <div class="card">
                    <h2 id="family-title">üèÜ Ranking</h2>
                    <div id="list-ranking">Cargando...</div>
                </div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card">
                    <h2>‚ûï Ganar Puntos</h2>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">¬øQui√©n hizo la tarea?</p>
                    <select id="select-user-action" style="margin-bottom:15px; background:#f9f9f9; font-weight:bold;"></select>
                    <label>Actividad Realizada</label>
                    <select id="select-task"><option>Cargando...</option></select>
                    <label>Minutos (Opcional)</label>
                    <input type="number" id="input-time" placeholder="Ej: 30">
                    <button class="btn" onclick="app.addPoints()">Guardar Puntos</button>
                </div>
            </div>

            <div id="view-redeem" class="hidden">
                <div class="card">
                    <h2>üéÅ Canjear Premios</h2>
                    <div id="list-redeem"></div>
                </div>
                <div class="card">
                    <h2>üìú Historial de Canjes</h2>
                    <div id="list-history" style="max-height: 300px; overflow-y:auto;">
                        <p style="text-align:center; color:#999;">Cargando historial...</p>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="hidden">
                <div class="card">
                    <h2>‚öôÔ∏è Mi Cuenta</h2>
                    <p>Usuario: <b id="my-email"></b></p>
                    <p>Viendo Familia: <span id="my-family-id" style="font-family:monospace; color:#888; font-size:0.7rem;"></span></p>
                </div>
                <div class="card">
                    <h2>üë• Miembros Familia</h2>
                    <div id="list-users"></div>
                    <div class="input-group">
                        <input id="new-u-name" placeholder="Nombre (ej: Hijo)">
                        <input id="new-u-email" placeholder="Email (Opcional)">
                    </div>
                    <button class="btn" onclick="app.createManualUser()">A√±adir Miembro</button>
                </div>
                <div class="card">
                    <h2>üßπ Actividades</h2>
                    <div id="list-tasks-admin"></div>
                    <div class="input-group">
                        <input id="new-t-name" placeholder="Nombre actividad">
                        <input id="new-t-pts" type="number" placeholder="Pts" style="width:70px; margin-left:5px;">
                    </div>
                    <button class="btn" onclick="app.createTask()">Crear Actividad</button>
                </div>
                <div class="card">
                    <h2>üéÅ Premios</h2>
                    <div id="list-rewards-admin"></div>
                    <div class="input-group">
                        <input id="new-r-name" placeholder="Nombre premio">
                        <input id="new-r-cost" type="number" placeholder="Pts" style="width:70px; margin-left:5px;">
                    </div>
                    <button class="btn" onclick="app.createReward()">Crear Premio</button>
                </div>
            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="app.nav('view-ranking', this)"><span>üèÜ</span>Ranking</div>
            <div class="nav-item" onclick="app.nav('view-add', this)"><span>‚ûï</span>Subir</div>
            <div class="nav-item" onclick="app.nav('view-redeem', this)"><span>üéÅ</span>Canjear</div>
            <div class="nav-item" onclick="app.nav('view-settings', this)"><span>‚öôÔ∏è</span>Ajustes</div>
        </nav>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-box">
            <h3 id="modal-title">Elegir Fecha</h3>
            <input type="date" id="modal-date" style="border:2px solid var(--primary); padding:15px;">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" style="background:#ccc; color:#333" onclick="document.getElementById('modal-overlay').classList.add('hidden')">Cancelar</button>
                <button class="btn" onclick="app.confirmRedeem()">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN (Verifica la URL antes de guardar)
        // ==========================================
        
        // 1. TU EMAIL (ADMIN)
        const SUPER_ADMIN_EMAIL = "raul.garcia.ortega@gmail.com"; 

        // 2. LA DIRECCI√ìN DE TU GITHUB (Aseg√∫rate que termina en /)
        const APP_URL = "https://raulgarciaortega-jpg.github.io/familypoints/"; 

        // ==========================================

        const firebaseConfig = {
            apiKey: "AIzaSyDhaA-USi3WZD67ymUMTHdrSxvwuoHBgIE",
            authDomain: "familypoints-dic-25.firebaseapp.com",
            projectId: "familypoints-dic-25",
            storageBucket: "familypoints-dic-25.firebasestorage.app",
            messagingSenderId: "555839746134",
            appId: "1:555839746134:web:0bf1e28fbe47438e5a4bf7",
            measurementId: "G-VTXWQBVP02"
        };

        let db, auth, currentUser;
        let selectedReward = null;
        let allUsers = []; 
        let currentFamilyId = null; // Familia que ESTOY VIENDO
        let realFamilyId = null;    // Familia a la que PERTENEZCO (DB)
        let listeners = [];

        const app = {
            init: function() {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                const urlParams = new URLSearchParams(window.location.search);
                const joinId = urlParams.get('join');
                if(joinId) sessionStorage.setItem('pendingJoin', joinId);

                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.setup(user);
                    } else {
                        document.getElementById('auth-screen').classList.remove('hidden');
                        document.getElementById('app-screen').classList.add('hidden');
                        document.getElementById('join-screen').classList.add('hidden');
                    }
                });
            },

            setup: function(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                let pendingJoin = sessionStorage.getItem('pendingJoin');

                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        currentUser = { uid: user.uid, ...userData };
                        if(!currentUser.name) db.collection('users').doc(user.uid).update({ name: user.email.split('@')[0] });

                        // Guardamos mi familia real segun la base de datos
                        realFamilyId = currentUser.familyId;

                        // --- L√ìGICA DE NAVEGACI√ìN ---
                        
                        if (pendingJoin) {
                            // SI SOY SUPER ADMIN: MODO OBSERVADOR (Sin cambios en DB)
                            if (currentUser.email === SUPER_ADMIN_EMAIL) {
                                currentFamilyId = pendingJoin; 
                                sessionStorage.removeItem('pendingJoin');
                                alert("üëÅÔ∏è MODO OBSERVADOR ACTIVADO\nEst√°s viendo esta familia sin unirte a ella.");
                            } 
                            // SI SOY NORMAL: CAMBIO DE FAMILIA REAL
                            else {
                                if (realFamilyId !== pendingJoin) {
                                    if(confirm("‚ö† ¬øMudarte a esta nueva familia?")) {
                                        db.collection('users').doc(user.uid).update({ familyId: pendingJoin })
                                        .then(() => {
                                            sessionStorage.removeItem('pendingJoin');
                                            window.location.reload(); 
                                        });
                                        return;
                                    } else {
                                        sessionStorage.removeItem('pendingJoin');
                                        currentFamilyId = realFamilyId;
                                    }
                                } else {
                                    currentFamilyId = realFamilyId;
                                    sessionStorage.removeItem('pendingJoin');
                                }
                            }
                        } 
                        else {
                            // Sin link, veo mi familia o mantengo la que estaba viendo
                            if (!currentFamilyId) currentFamilyId = realFamilyId;
                        }

                        this.renderUI();

                    } else {
                        // Usuario nuevo
                        const initialData = { name: user.email.split('@')[0], email: user.email, points: 0, createdAt: new Date() };
                        if(pendingJoin) { initialData.familyId = pendingJoin; sessionStorage.removeItem('pendingJoin'); }
                        db.collection('users').doc(user.uid).set(initialData);
                    }
                });
            },

            renderUI: function() {
                window.history.replaceState({}, document.title, window.location.pathname);

                if (currentFamilyId) {
                    this.loadFamilyData(); 
                    this.getFamilyName(currentFamilyId);

                    document.getElementById('app-screen').classList.remove('hidden');
                    document.getElementById('join-screen').classList.add('hidden');
                    document.getElementById('header-user').innerText = `${currentUser.name} (${currentUser.points || 0} pts)`;
                    document.getElementById('my-email').innerText = currentUser.email;
                    document.getElementById('my-family-id').innerText = currentFamilyId;

                    // L√≥gica visual Admin
                    if(currentUser.email === SUPER_ADMIN_EMAIL) {
                        this.initSuperAdmin();
                        
                        if(currentFamilyId !== realFamilyId) {
                            document.getElementById('observer-mode').style.display = 'block';
                            document.getElementById('header-family-name').style.display = 'none';
                        } else {
                            document.getElementById('observer-mode').style.display = 'none';
                            document.getElementById('header-family-name').style.display = 'block';
                        }
                    }

                } else {
                    if(currentUser.email === SUPER_ADMIN_EMAIL) {
                        document.getElementById('app-screen').classList.remove('hidden');
                        this.initSuperAdmin();
                    } else {
                        document.getElementById('join-screen').classList.remove('hidden');
                    }
                }
            },

            detachListeners: function() {
                listeners.forEach(unsubscribe => unsubscribe());
                listeners = [];
                document.getElementById('list-ranking').innerHTML = "<div style='padding:10px; color:#888'>Cargando datos...</div>";
                document.getElementById('list-users').innerHTML = "";
                document.getElementById('list-tasks-admin').innerHTML = "";
                document.getElementById('list-redeem').innerHTML = "";
            },

            loadFamilyData: function() {
                if(!currentFamilyId) return;
                this.detachListeners();
                
                // 1. USUARIOS
                const unsubUsers = db.collection('users').where('familyId', '==', currentFamilyId).onSnapshot(snap => {
                    const listRanking = document.getElementById('list-ranking');
                    const listAdmin = document.getElementById('list-users');
                    const selectUser = document.getElementById('select-user-action'); 
                    
                    listRanking.innerHTML = ""; listAdmin.innerHTML = ""; selectUser.innerHTML = "";
                    allUsers = [];
                    snap.forEach(d => allUsers.push({id:d.id, ...d.data()}));
                    allUsers.sort((a,b) => (b.points||0) - (a.points||0));

                    allUsers.forEach(u => {
                        const safeName = u.name || "Sin nombre";
                        // En el ranking, ocultamos al Admin si est√° de "mir√≥n" (si su ID no coincide con esta familia en DB, no sale,
                        // pero si sali√≥ porque la DB estaba mal, esto lo limpiar√° visualmente mientras lo arreglas)
                        
                        listRanking.innerHTML += `<div class="list-item"><span style="font-size:1.1rem">${safeName}</span> <span class="user-pill">${u.points||0}</span></div>`;
                        
                        let delBtn = u.isVirtual ? `<button class="btn-icon" style="color:red" onclick="app.del('users', '${u.id}')">üóëÔ∏è</button>` : '';
                        listAdmin.innerHTML += `<div class="list-item"><span style="font-size:0.85rem"><b>${safeName}</b><br><small>${u.email||''}</small></span><div><button class="btn-icon" onclick="app.editUser('${u.id}', '${safeName}')">‚úèÔ∏è</button>${delBtn}</div></div>`;
                        
                        let opt = document.createElement('option');
                        opt.value = u.id; opt.text = safeName + (currentUser && u.id === currentUser.uid ? " (Yo)" : "");
                        if(currentUser && u.id === currentUser.uid) opt.selected = true;
                        selectUser.appendChild(opt);
                    });
                });
                listeners.push(unsubUsers);

                // 2. TAREAS Y PREMIOS (Igual que antes)
                const unsubTasks = db.collection('tasks').where('familyId', '==', currentFamilyId).onSnapshot(snap => {
                    const sel = document.getElementById('select-task');
                    const list = document.getElementById('list-tasks-admin');
                    sel.innerHTML = "<option value=''>Elige actividad...</option>"; list.innerHTML = "";
                    snap.forEach(d => {
                        const t = d.data();
                        let opt = document.createElement('option');
                        opt.value = d.id; opt.setAttribute('data-pts', t.pts); opt.text = `${t.name} (+${t.pts})`;
                        sel.appendChild(opt);
                        list.innerHTML += `<div class="list-item"><span>${t.name} (+${t.pts})</span> <button class="btn-del" onclick="app.del('tasks','${d.id}')">X</button></div>`;
                    });
                });
                listeners.push(unsubTasks);

                const unsubRewards = db.collection('rewards').where('familyId', '==', currentFamilyId).onSnapshot(snap => {
                    const listR = document.getElementById('list-redeem');
                    const listA = document.getElementById('list-rewards-admin');
                    listR.innerHTML = ""; listA.innerHTML = "";
                    snap.forEach(d => {
                        const r = d.data();
                        const can = (currentUser.points || 0) >= r.cost;
                        const btnStyle = can ? 'background:var(--primary)' : 'background:#ccc; cursor:not-allowed';
                        listR.innerHTML += `<div class="list-item"><div><b>${r.name}</b><br><small>${r.cost} pts</small></div><button onclick="app.askRedeem('${r.name}', ${r.cost})" style="${btnStyle}; color:white; border:none; padding:8px 12px; border-radius:5px;">Canjear</button></div>`;
                        listA.innerHTML += `<div class="list-item"><span>${r.name} (-${r.cost})</span> <button class="btn-del" onclick="app.del('rewards','${d.id}')">X</button></div>`;
                    });
                });
                listeners.push(unsubRewards);
                
                const unsubHistory = db.collection('history').where('familyId', '==', currentFamilyId).orderBy('timestamp', 'desc').limit(20).onSnapshot(snap => {
                    const listH = document.getElementById('list-history');
                    listH.innerHTML = "";
                    if(snap.empty) { listH.innerHTML = "<p style='text-align:center; color:#ccc;'>Sin historial.</p>"; return; }
                    snap.forEach(d => {
                        const h = d.data();
                        listH.innerHTML += `<div class="history-item"><div class="history-date">üìÖ ${h.date}</div><div><b>${h.userName}</b> canje√≥ <span style="color:var(--primary)">${h.rewardName}</span> (${h.cost} pts)</div></div>`;
                    });
                });
                listeners.push(unsubHistory);
            },

            getFamilyName: function(famId) {
                db.collection('families').doc(famId).get().then(doc => {
                    if(doc.exists) {
                        const name = doc.data().name;
                        document.getElementById('header-family-name').innerText = "Familia: " + name;
                    }
                });
            },

            // --- SUPER ADMIN PANEL ---
            initSuperAdmin: function() {
                const panel = document.getElementById('admin-panel');
                panel.style.display = 'block';
                db.collection('families').onSnapshot(snap => {
                    const list = document.getElementById('sa-fam-list');
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const f = doc.data();
                        const baseUrl = APP_URL.endsWith('/') ? APP_URL : APP_URL + '/';
                        const link = baseUrl + "?join=" + doc.id;
                        
                        // Bot√≥n especial para que el Admin se mude a su casa
                        const isMyHome = (realFamilyId === doc.id) ? " (Tu Casa)" : "";
                        const homeBtnStyle = (realFamilyId === doc.id) ? "background:#00b894" : "background:#636e72";

                        list.innerHTML += `
                            <div class="admin-card">
                                <div><b>${f.name}</b>${isMyHome}<br><small>ID: ${doc.id}</small></div>
                                <div class="admin-actions">
                                    <button class="btn-mini btn-copy" onclick="app.copyLink('${link}')">Copiar Link</button>
                                    <button class="btn-mini btn-move" onclick="app.adminSetMyHome('${doc.id}')" title="Fijar como mi familia real">üè† Mudarme Aqu√≠</button>
                                    <button class="btn-mini btn-del" onclick="app.saDeleteFamily('${doc.id}')">üóëÔ∏è</button>
                                </div>
                            </div>`;
                    });
                });
            },

            adminSetMyHome: function(famId) {
                if(confirm("¬øQuieres establecer esta familia como TU familia real?\n(Desaparecer√°s de la lista de otras familias)")) {
                    db.collection('users').doc(currentUser.uid).update({ familyId: famId })
                    .then(() => {
                        alert("¬°Hecho! Ahora perteneces a esta familia.\nRecargando...");
                        window.location.reload();
                    });
                }
            },

            saCreateFamily: function() {
                const name = document.getElementById('sa-fam-name').value;
                if(!name) return;
                db.collection('families').add({ name: name, createdAt: new Date(), createdBy: currentUser.email })
                    .then(() => { alert("Familia creada."); document.getElementById('sa-fam-name').value = ""; });
            },

            saDeleteFamily: function(id) {
                if(confirm("‚ö† ¬øSeguro que quieres borrar esta familia?")) {
                    db.collection('families').doc(id).delete();
                }
            },

            copyLink: function(text) {
                navigator.clipboard.writeText(text).then(() => alert("‚úÖ Link copiado! Env√≠alo por Whatsapp:\n" + text));
            },

            // --- USER ACTIONS ---
            createManualUser: function() {
                const n = document.getElementById('new-u-name').value;
                const e = document.getElementById('new-u-email').value;
                if(!n) return alert("Nombre obligatorio");
                // IMPORTANTE: Creamos usuario en la familia que ESTAMOS VIENDO (currentFamilyId)
                db.collection('users').add({ name: n, email: e || "virtual@fam.app", points: 0, isVirtual: true, familyId: currentFamilyId })
                    .then(() => { document.getElementById('new-u-name').value = ""; document.getElementById('new-u-email').value = ""; });
            },
            createTask: function() {
                const n = document.getElementById('new-t-name').value;
                const p = parseInt(document.getElementById('new-t-pts').value);
                if(n && p) { db.collection('tasks').add({ name:n, pts:p, familyId: currentFamilyId }); document.getElementById('new-t-name').value=""; document.getElementById('new-t-pts').value=""; }
            },
            createReward: function() {
                const n = document.getElementById('new-r-name').value;
                const c = parseInt(document.getElementById('new-r-cost').value);
                if(n && c) { db.collection('rewards').add({ name:n, cost:c, familyId: currentFamilyId }); document.getElementById('new-r-name').value=""; document.getElementById('new-r-cost').value=""; }
            },
            addPoints: function() {
                const userSelect = document.getElementById('select-user-action');
                const taskSelect = document.getElementById('select-task');
                const targetUserId = userSelect.value;
                if(!targetUserId || !taskSelect.value) return alert("Faltan datos.");
                const pts = parseInt(taskSelect.options[taskSelect.selectedIndex].getAttribute('data-pts'));
                const targetUser = allUsers.find(u => u.id === targetUserId);
                
                // Protecci√≥n: Admin no se suma puntos en familia ajena
                if(targetUserId === currentUser.uid && currentFamilyId !== realFamilyId) {
                    if(!confirm("‚ö† Est√°s en Modo Observador. ¬øSeguro que quieres sumarte puntos a TI mismo en esta familia ajena?")) return;
                }

                db.collection('users').doc(targetUserId).update({ points: (targetUser.points || 0) + pts })
                    .then(() => { alert(`¬°${pts} puntos sumados!`); app.nav('view-ranking', document.querySelectorAll('.nav-item')[0]); });
            },
            askRedeem: function(name, cost) {
                if((currentUser.points || 0) < cost) return alert("Faltan puntos");
                selectedReward = { name, cost };
                document.getElementById('modal-title').innerText = "Canjear: " + name;
                document.getElementById('modal-date').valueAsDate = new Date();
                document.getElementById('modal-overlay').classList.remove('hidden');
            },
            confirmRedeem: function() {
                const date = document.getElementById('modal-date').value;
                if(!date) return alert("Falta fecha");
                db.collection('users').doc(currentUser.uid).update({ points: currentUser.points - selectedReward.cost });
                db.collection('history').add({
                    rewardName: selectedReward.name, cost: selectedReward.cost, date: date,
                    userName: currentUser.name, userId: currentUser.uid, familyId: currentFamilyId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                db.collection('users').where('familyId', '==', currentFamilyId).get().then(snap => {
                    let emails = [];
                    snap.forEach(d => { const u = d.data(); if(u.email && !u.isVirtual) emails.push(u.email); });
                    const subject = encodeURIComponent("Canje: " + currentUser.name);
                    const body = encodeURIComponent(`${currentUser.name} canje√≥:\nüéÅ ${selectedReward.name}\nüìÖ ${date}\nüí∞ ${selectedReward.cost} pts.`);
                    window.location.href = `mailto:${emails.join(',')}?subject=${subject}&body=${body}`;
                    document.getElementById('modal-overlay').classList.add('hidden');
                });
            },
            del: function(col, id) { if(confirm("¬øBorrar?")) db.collection(col).doc(id).delete(); },
            editUser: function(id, currentName) { const n = prompt("Nombre:", currentName); if(n) db.collection('users').doc(id).update({name: n}); },

            login: function() {
                const e = document.getElementById('email').value;
                const p = document.getElementById('pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(err => document.getElementById('auth-error').innerText = err.message);
            },
            register: function() {
                const e = document.getElementById('email').value;
                const p = document.getElementById('pass').value;
                auth.createUserWithEmailAndPassword(e, p).then(cred => {}).catch(err => document.getElementById('auth-error').innerText = err.message);
            },
            logout: function() { auth.signOut(); location.reload(); },
            nav: function(view, el) {
                document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
                document.getElementById(view).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
