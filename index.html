<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Points</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4a90e2; --accent: #50e3c2; --danger: #e74c3c; --bg: #f4f7f6; --card: #ffffff; --text: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- PANTALLA DE CARGA / LOGIN --- */
        #auth-screen { position: fixed; inset: 0; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; padding: 20px; transition: opacity 0.3s; }
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 340px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .app-title { font-size: 2rem; color: white; font-weight: 800; margin-bottom: 20px; letter-spacing: 1px; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fafafa; }
        .btn-auth { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-login { background: var(--primary); color: white; }
        .btn-register { background: white; border: 2px solid var(--primary); color: var(--primary); }

        /* --- INTERFAZ PRINCIPAL --- */
        header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        h2 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 8px; }
        h3 { font-size: 0.85rem; text-transform: uppercase; color: #888; margin: 15px 0 5px 0; letter-spacing: 0.5px; }

        /* Elementos de Listas */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .list-item:last-child { border-bottom: none; }
        .pts-pill { background: #e3f2fd; color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
        
        select { width: 100%; height: 45px; border: 1px solid #ddd; border-radius: 8px; padding: 0 10px; font-size: 16px; background: #fff; margin-bottom: 10px; }
        .row-inputs { display: flex; gap: 8px; }

        .btn { width: 100%; height: 45px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 1rem; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--accent); color: #004d40; }
        .btn-danger { background: var(--danger); }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; background: #ffebee; color: var(--danger); font-size: 1.2rem; display: flex; justify-content: center; align-items: center; cursor: pointer; }

        /* Navbar Inferior */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 65px; background: white; border-top: 1px solid #eee; display: grid; grid-template-columns: repeat(4, 1fr); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 10px; color: #999; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { font-size: 22px; margin-bottom: 2px; }

        .hidden { display: none !important; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; color: var(--primary); font-weight: bold; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>Conectando a Family Points...</div>
    </div>

    <div id="auth-screen">
        <div class="app-title">FAMILY POINTS</div>
        <div class="login-card">
            <h3 style="margin-top:0; margin-bottom:15px; text-align:center;">Bienvenido a casa</h3>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            
            <button class="btn-auth btn-login" onclick="handleLogin()">Iniciar Sesi√≥n</button>
            <button class="btn-auth btn-register" onclick="handleRegister()">Registrarse</button>
            <p id="login-msg" style="font-size: 0.8rem; color: #d32f2f; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <span id="user-display" class="user-badge">Cargando...</span>
            <button onclick="handleLogout()" style="background:none; border:none; color:white; font-size:0.9rem; cursor:pointer">Salir</button>
        </header>

        <div class="main-content">
            
            <div id="view-ranking">
                <div class="card">
                    <h2>üèÜ Ranking Familiar</h2>
                    <div id="ranking-list">
                        <p style="text-align:center; color:#999">Cargando puntuaciones...</p>
                    </div>
                </div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card">
                    <h2>‚ûï Sumar Puntos</h2>
                    <label>¬øQu√© has hecho?</label>
                    <select id="task-select">
                        <option value="">Cargando actividades...</option>
                    </select>
                    
                    <label>Tiempo (minutos)</label>
                    <input type="number" id="task-time" placeholder="Ej: 30">
                    
                    <button class="btn btn-primary" onclick="addPoints()">Registrar Tarea</button>
                </div>
            </div>

            <div id="view-redeem" class="hidden">
                <div class="card">
                    <h2>üéÅ Canjear Premios</h2>
                    <p style="font-size:0.85rem; color:#666; margin-bottom:15px">Selecciona un premio para canjearlo. Se descontar√°n tus puntos.</p>
                    <div id="redeem-list">
                        <p style="text-align:center; color:#999">Cargando premios...</p>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="hidden">
                <div class="card">
                    <h2>‚öôÔ∏è Configuraci√≥n</h2>
                    <p style="font-size:0.9rem">Usuario: <strong id="settings-email"></strong></p>
                </div>

                <div class="card">
                    <h2>üë• Familiares</h2>
                    <div id="users-list"></div>
                    <p style="font-size:0.75rem; color:#999; margin-top:10px; text-align:center">
                        Para a√±adir a alguien, dile que se registre con la app.
                    </p>
                </div>

                <div class="card">
                    <h2>üßπ Actividades (Ganar)</h2>
                    <div id="tasks-list"></div>
                    <h3>Crear Nueva Actividad</h3>
                    <div class="row-inputs">
                        <input type="text" id="new-task-name" placeholder="Nombre">
                        <input type="number" id="new-task-pts" placeholder="Pts" style="width:80px">
                    </div>
                    <button class="btn btn-success" onclick="createTask()">A√±adir</button>
                </div>

                <div class="card">
                    <h2>üéÅ Premios (Gastar)</h2>
                    <div id="rewards-list"></div>
                    <h3>Crear Nuevo Premio</h3>
                    <div class="row-inputs">
                        <input type="text" id="new-reward-name" placeholder="Nombre">
                        <input type="number" id="new-reward-cost" placeholder="Coste" style="width:80px">
                    </div>
                    <button class="btn btn-success" onclick="createReward()">A√±adir</button>
                </div>
            </div>

        </div>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="nav('view-ranking', this)"><span>üèÜ</span>Ranking</div>
            <div class="nav-item" onclick="nav('view-add', this)"><span>‚ûï</span>Subir</div>
            <div class="nav-item" onclick="nav('view-redeem', this)"><span>üéÅ</span>Canjear</div>
            <div class="nav-item" onclick="nav('view-settings', this)"><span>‚öôÔ∏è</span>Ajustes</div>
        </nav>
    </div>

    <script>
        // -------------------------------------------------------------
        // CONFIGURACI√ìN FIREBASE (Tus claves reales)
        // -------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDhaA-USi3WZD67ymUMTHdrSxvwuoHBgIE",
            authDomain: "familypoints-dic-25.firebaseapp.com",
            projectId: "familypoints-dic-25",
            storageBucket: "familypoints-dic-25.firebasestorage.app",
            messagingSenderId: "555839746134",
            appId: "1:555839746134:web:0bf1e28fbe47438e5a4bf7",
            measurementId: "G-VTXWQBVP02"
        };
        // -------------------------------------------------------------

        // Variables Globales
        let auth, db;
        let currentUser = null;

        // INICIALIZACI√ìN
        function initApp() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();
                
                // Escuchar estado de autenticaci√≥n
                auth.onAuthStateChanged(user => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    if (user) {
                        console.log("Usuario conectado:", user.email);
                        setupApp(user);
                    } else {
                        console.log("No hay usuario conectado");
                        showAuth();
                    }
                });
            } catch (error) {
                console.error("Error Firebase:", error);
                alert("Error de conexi√≥n. Verifica la consola.");
                document.getElementById('loading-overlay').innerText = "Error de conexi√≥n";
            }
        }

        // --- GESTI√ìN DE PANTALLAS ---
        function showAuth() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            currentUser = null;
        }

        function setupApp(user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            // Escuchar cambios en mi propio usuario
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    currentUser = { uid: user.uid, ...doc.data() };
                    document.getElementById('user-display').innerText = `${currentUser.name} (${currentUser.points || 0})`;
                    document.getElementById('settings-email').innerText = currentUser.email;
                }
            });

            // Cargar datos en tiempo real
            listenToData();
        }

        function nav(viewId, el) {
            document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        // --- AUTHENTICATION ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            msg.innerText = "";

            if(!email || !pass) return msg.innerText = "Rellena todos los campos";

            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (error) {
                msg.innerText = "Error: " + error.message;
            }
        }

        async function handleRegister() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            msg.innerText = "";

            if(!email || !pass) return msg.innerText = "Rellena todos los campos";

            try {
                // 1. Crear Auth
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                // 2. Crear documento User en DB
                const name = email.split('@')[0];
                await db.collection('users').doc(cred.user.uid).set({
                    name: name.charAt(0).toUpperCase() + name.slice(1), // Capitalizar
                    email: email,
                    points: 0,
                    joined: new Date()
                });
                alert("Cuenta creada con √©xito");
            } catch (error) {
                msg.innerText = "Error registro: " + error.message;
            }
        }

        function handleLogout() {
            auth.signOut();
            window.location.reload();
        }

        // --- BASE DE DATOS (LISTENERS) ---
        function listenToData() {
            // 1. Usuarios (Ranking)
            db.collection('users').onSnapshot(snap => {
                const list = document.getElementById('ranking-list');
                const listSettings = document.getElementById('users-list');
                list.innerHTML = "";
                listSettings.innerHTML = "";
                
                let users = [];
                snap.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                users.sort((a,b) => (b.points || 0) - (a.points || 0)); // Ordenar por puntos

                users.forEach(u => {
                    // Ranking Principal
                    list.innerHTML += `
                        <div class="list-item">
                            <span style="font-weight:500; font-size:1.1rem">${u.name}</span>
                            <span class="pts-pill" style="font-size:1rem">${u.points || 0} pts</span>
                        </div>`;
                    
                    // Lista Ajustes
                    listSettings.innerHTML += `
                        <div class="list-item">
                            <span>${u.name} (${u.email})</span>
                            <span class="pts-pill">${u.points || 0}</span>
                        </div>`;
                });
            });

            // 2. Tareas (Ganar Puntos)
            db.collection('tasks').onSnapshot(snap => {
                const select = document.getElementById('task-select');
                const list = document.getElementById('tasks-list');
                
                // Guardar selecci√≥n actual para no perderla al refrescar
                const currentVal = select.value;
                select.innerHTML = "<option value=''>Selecciona actividad...</option>";
                list.innerHTML = "";

                snap.forEach(doc => {
                    const t = doc.data();
                    // Select
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.setAttribute('data-pts', t.pts);
                    opt.text = `${t.name} (+${t.pts} pts)`;
                    select.appendChild(opt);

                    // Lista Ajustes
                    list.innerHTML += `
                        <div class="list-item">
                            <span>${t.name} (+${t.pts})</span>
                            <button class="btn-icon" onclick="deleteItem('tasks', '${doc.id}')">üóëÔ∏è</button>
                        </div>`;
                });
                select.value = currentVal;
            });

            // 3. Premios (Canjear)
            db.collection('rewards').onSnapshot(snap => {
                const redeemList = document.getElementById('redeem-list');
                const settingsList = document.getElementById('rewards-list');
                redeemList.innerHTML = "";
                settingsList.innerHTML = "";

                snap.forEach(doc => {
                    const r = doc.data();
                    const canAfford = currentUser && (currentUser.points || 0) >= r.cost;
                    
                    // Vista Canjear
                    const btnStyle = canAfford ? 'background:var(--primary)' : 'background:#e0e0e0; color:#999';
                    const cursor = canAfford ? 'pointer' : 'not-allowed';
                    
                    redeemList.innerHTML += `
                        <div class="list-item">
                            <div>
                                <strong style="font-size:1rem">${r.name}</strong><br>
                                <small style="color:#666">${r.cost} pts</small>
                            </div>
                            <button style="${btnStyle}; border:none; padding:8px 16px; border-radius:8px; font-weight:bold; cursor:${cursor}" 
                                onclick="redeemPrize('${r.name}', ${r.cost})">Canjear</button>
                        </div>`;

                    // Vista Ajustes
                    settingsList.innerHTML += `
                        <div class="list-item">
                            <span>${r.name} (-${r.cost})</span>
                            <button class="btn-icon" onclick="deleteItem('rewards', '${doc.id}')">üóëÔ∏è</button>
                        </div>`;
                });
            });
        }

        // --- ACCIONES PRINCIPALES ---

        async function addPoints() {
            const select = document.getElementById('task-select');
            const time = document.getElementById('task-time').value;

            if(!select.value || !time) return alert("Selecciona una tarea y pon el tiempo.");

            const pts = parseInt(select.options[select.selectedIndex].getAttribute('data-pts'));
            const currentPoints = currentUser.points || 0;

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    points: currentPoints + pts
                });
                alert(`¬°+${pts} puntos a√±adidos!`);
                // Limpiar campos
                select.value = "";
                document.getElementById('task-time').value = "";
                nav('view-ranking', document.querySelector('.nav-item')); // Ir al ranking
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        async function redeemPrize(name, cost) {
            if((currentUser.points || 0) < cost) return alert("No tienes suficientes puntos.");

            if(confirm(`¬øConfirmas canjear "${name}" por ${cost} puntos?`)) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        points: currentUser.points - cost
                    });
                    alert("¬°Canje realizado! Disfruta.");
                } catch (e) {
                    alert("Error: " + e.message);
                }
            }
        }

        // --- ACCIONES ADMIN (CREAR/BORRAR) ---

        function createTask() {
            const name = document.getElementById('new-task-name').value;
            const pts = parseInt(document.getElementById('new-task-pts').value);
            if(name && pts) {
                db.collection('tasks').add({ name, pts });
                document.getElementById('new-task-name').value = "";
                document.getElementById('new-task-pts').value = "";
            }
        }

        function createReward() {
            const name = document.getElementById('new-reward-name').value;
            const cost = parseInt(document.getElementById('new-reward-cost').value);
            if(name && cost) {
                db.collection('rewards').add({ name, cost });
                document.getElementById('new-reward-name').value = "";
                document.getElementById('new-reward-cost').value = "";
            }
        }

        function deleteItem(collection, id) {
            if(confirm("¬øEliminar este elemento para todos?")) {
                db.collection(collection).doc(id).delete();
            }
        }

        // Arrancar
        window.onload = initApp;

    </script>
</body>
</html>
